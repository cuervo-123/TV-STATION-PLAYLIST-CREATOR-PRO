<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mi TV Station</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    :root{--bg:#0f1115;--fg:#e6e8eb;--accent:#00ffd5;--muted:#9aa4af}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    header,main{padding:16px;max-width:1100px;margin:0 auto}
    h1{margin:0 0 12px;font-weight:800;letter-spacing:.3px}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .col{flex:1 1 350px;min-width:300px}
    .panel{background:#131722;border:1px solid #222836;border-radius:14px;padding:14px;box-shadow:0 4px 24px rgba(0,0,0,.25)}
    .panel h3{margin:0 0 10px;color:var(--accent)}
    video{width:100%;height:360px;background:black;border-radius:12px}
    button,select,input{background:#1a2030;color:var(--fg);border:1px solid #2a3142;border-radius:10px;padding:10px 12px;font-size:14px}
    button{cursor:pointer}
    button:hover{border-color:#3b465c}
    ul{margin:8px 0 0;padding-left:20px}
    .muted{color:var(--muted)}
    .row.gap8{gap:8px}
    .tag{display:inline-block;background:#1e2536;border:1px solid #2b3448;border-radius:999px;padding:4px 10px;font-size:12px;color:#b7c1cc}
    details summary{cursor:pointer}
    .chip{display:inline-flex;align-items:center;gap:8px;background:#1a2030;border:1px solid #2a3142;border-radius:999px;padding:6px 10px}

    /* ===== Listado de canales con bot√≥n rojo ===== */
    .channel-list{
      width:100%;
      max-height: 300px;
      overflow:auto;
      border:1px solid #2a3142;
      border-radius:10px;
      background:#0f121a;
    }
    .channel-item{
      display:flex; align-items:center; gap:10px;
      padding:8px 10px;
      border-bottom:1px solid #1f2533;
      user-select:none; cursor:pointer;
    }
    .channel-item:last-child{ border-bottom:none; }
    .channel-item.selected{ background:#1e2536; }
    .channel-name{
      flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .play-btn{
      background:#e53935; border:1px solid #b71c1c; color:#fff;
      border-radius:8px; padding:6px 10px; font-weight:700;
      cursor:pointer;
    }
    .play-btn:hover{ filter:brightness(1.08); }
  </style>
</head>
<body>
  <header>
    <h1>üì∫ Mi TV Station</h1>
    <p class="muted">Carga listas <span class="tag">.m3u</span> / <span class="tag">.m3u8</span>, guarda favoritos, playlists y categor√≠as. Reproduce HLS con <strong>HLS.js</strong>.</p>
  </header>

  <main>
    <div class="row">
      <div class="col panel">
        <h3>Reproductor</h3>
        <video id="videoPlayer" controls autoplay playsinline></video>
        <div class="row gap8" style="margin-top:10px">
          <button id="btnFav" type="button">‚≠ê Agregar a Favoritos</button>
          <button id="btnAleatorio" type="button">‚ñ∂Ô∏è Reproducir selecci√≥n aleatoria</button>
          <button id="btnStop" type="button">‚èπÔ∏è Stop</button>
        </div>
        <!-- Temporizador externo para modo Auto-Aleatorio -->
        <div class="row" id="autoRandomControls" style="margin-top:10px; gap:8px; align-items:center;">
          <span class="muted">‚è±Ô∏è Temporizador (segundos):</span>
          <input type="number" id="randSeconds" min="5" max="3600" step="5" value="60" style="width:110px"/>
          <input type="range" id="randRange" min="5" max="1800" step="5" value="60" style="flex:1"/>
          <button id="btnStartAuto" type="button">üîÅ Iniciar Auto</button>
          <button id="btnPauseAuto" type="button">‚è∏Ô∏è Pausa/Continuar</button>
          <button id="btnStopAuto" type="button">‚èπÔ∏è Detener Auto</button>
        </div>
        <div class="muted" id="countdownLabel" style="margin-top:4px">Pr√≥ximo cambio en ‚Äî</div>
      </div>

      <div class="col panel">
        <h3>Canales</h3>
        <input id="searchBox" placeholder="Buscar por nombre o categor√≠a..." style="width:100%;margin-bottom:8px"/>

        <!-- Controles r√°pidos arriba -->
        <div class="row gap8" style="margin-bottom:8px;align-items:center;">
          <button id="btnPlayTop" type="button">üì∫ Reproducir</button>
          <button id="btnRandomTop" type="button">üé≤ Aleatorio</button>
          <label class="chip"><input type="checkbox" id="chkClickPlay"> Clic reproduce</label>
          <span class="muted" style="font-size:12px;">Atajos: Enter/P, R, F</span>
        </div>

        <!-- NUEVO: contenedor de canales con bot√≥n rojo -->
        <div id="channelList" class="channel-list"></div>

        <div class="row gap8" style="margin-top:8px">
          <button id="btnPlay" type="button">üì∫ Reproducir seleccionado</button>
          <button id="btnExportSel" type="button">‚¨áÔ∏è Exportar selecci√≥n (.m3u)</button>
        </div>
        <div class="muted" style="margin-top:6px"><span id="countLabel">0</span> canales cargados</div>

        <!-- ===== Auto-carga de listas internas ===== -->
        <div class="row gap8" style="margin-top:12px; align-items:center;">
          <button id="btnLoadInternal" type="button">üì• Cargar internas</button>
          <button id="btnForceInternal" type="button" title="Ignora cach√©">‚Üª Forzar</button>
          <label class="muted" style="display:flex; align-items:center; gap:6px;">
            <input type="checkbox" id="chkMergeInternal" checked> Fusionar con actual
          </label>
          <label class="muted" style="display:flex; align-items:center; gap:6px;">
            <input type="checkbox" id="chkAutoInternal"> Auto-cargar al abrir
          </label>
        </div>
        <details style="margin-top:6px">
          <summary class="muted">Opciones (elegir listas)</summary>
          <div class="row" style="gap:12px; margin-top:8px; flex-wrap:wrap;">
            <label><input type="checkbox" class="internal-item" value="update2.m3u" checked> update2.m3u</label>
            <label><input type="checkbox" class="internal-item" value="xumo.m3u" checked> xumo.m3u</label>
            <label><input type="checkbox" class="internal-item" value="xiaomi.m3u" checked> xiaomi.m3u</label>
          </div>
        </details>
        <div class="muted" id="internalStatus" style="margin-top:6px">‚Äî</div>
        <!-- ======================================== -->
      </div>
    </div>

    <div class="row" style="margin-top:16px">
      <div class="col panel">
        <h3>Importar / Guardar Playlists</h3>
        <input type="file" accept=".m3u,.m3u8" id="playlistFile" />
        <div class="row gap8" style="margin-top:10px">
          <input id="playlistName" placeholder="Nombre de la playlist" style="flex:1"/>
          <button id="btnGuardarPL" type="button">üíæ Guardar selecci√≥n</button>
        </div>
        <div class="row gap8" style="margin-top:10px">
          <select id="savedPlaylists" style="flex:1">
            <option value="">Selecciona una lista...</option>
          </select>
          <button id="btnLoadPL" type="button">üìÇ Cargar</button>
          <button id="btnDeletePL" type="button">üóëÔ∏è Eliminar</button>
          <button id="btnExportPL" type="button">‚¨áÔ∏è Exportar (.m3u)</button>
        </div>
      </div>

      <div class="col panel">
        <h3>‚≠ê Favoritos</h3>
        <select id="favoritosDropdown" multiple size="8" style="width:100%"></select>
        <div class="row gap8" style="margin-top:8px">
          <button id="btnPlayFav" type="button">üì∫ Reproducir</button>
          <button id="btnDelFav" type="button">‚ùå Eliminar</button>
          <button id="btnExportFav" type="button">‚¨áÔ∏è Exportar (.m3u)</button>
        </div>

        <h3 style="margin-top:16px">Categor√≠as</h3>
        <div class="row gap8">
          <select id="categoryDropdown" style="flex:1">
            <option value="">Selecciona una categor√≠a...</option>
          </select>
          <button id="btnNewCat" type="button">üìù Crear</button>
          <button id="btnAddToCat" type="button">üîÄ A√±adir selecci√≥n</button>
        </div>
        <h4 style="margin:12px 0 6px">Canales de esta Categor√≠a</h4>
        <ul id="categoryChannelsList"></ul>
      </div>
    </div>

    <div class="panel" style="margin-top:16px">
      <h3>Editor (placeholder)</h3>
      <button id="toggleEditorBtn" type="button">üéõÔ∏è Mostrar/ocultar editor</button>
      <div id="channelEditor" style="display:none; margin-top:10px" class="muted">Aqu√≠ puedes construir tu editor visual m√°s adelante.</div>
    </div>
  </main>

  <script>
  // ========= Utilidades M3U / JSON =========
  const M3U = {
    parse(text){
      if(!text || !text.trim()) return [];
      const t = text.trim();
      if(t.startsWith('[') || t.startsWith('{')){
        try{
          const data = JSON.parse(t);
          if(Array.isArray(data)) return data.filter(x => x && x.url && x.name);
          if(data && Array.isArray(data.items)) return data.items.filter(x => x && x.url && x.name);
        }catch(e){}
      }
      const lines = t.split(/\r?\n/).map(l => l.trim());
      const out = [];
      let meta = null;
      for(let i=0;i<lines.length;i++){
        const line = lines[i];
        if(!line || line.startsWith('#EXTM3U')) continue;
        if(line.startsWith('#EXTINF')){
          const name = (line.split(',')[1] || '').trim();
          const logoMatch = line.match(/tvg-logo="([^"]+)"/i);
          const groupMatch = line.match(/group-title="([^"]+)"/i);
          meta = { name: name || 'Canal', logo: logoMatch?logoMatch[1]:undefined, group: groupMatch?groupMatch[1]:undefined };
        } else if(!line.startsWith('#')){
          if(meta){ out.push({ name: meta.name, url: line, logo: meta.logo, group: meta.group }); meta = null; }
          else { out.push({ name: 'Canal', url: line }); }
        }
      }
      return out;
    },
    stringify(arr){ try{ return JSON.stringify(arr || []); }catch(e){ return '[]'; } },
    toM3U(arr){
      let out = ['#EXTM3U'];
      (arr||[]).forEach(ch => {
        const g = ch.group ? ` group-title="${escapeAttr(ch.group)}"` : '';
        theLogo = ch.logo ? ` tvg-logo="${escapeAttr(ch.logo)}"` : '';
        const name = ch.name || 'Canal';
        out.push(`#EXTINF:-1${theLogo}${g},${name}`);
        out.push(ch.url);
      });
      return out.join('\\n');
    }
  };
  function escapeAttr(s){ return (s||'').replace(/"/g,'\\"'); }

  // ========= Estado principal =========
  let playlist = [];
  let currentStream = null;
  const video = document.getElementById('videoPlayer');

  // NUEVO contenedor
  const channelList = document.getElementById('channelList');
  let selectedSet = new Set(); // urls seleccionadas

  const favoritosDropdown = document.getElementById('favoritosDropdown');
  const savedPlaylistsDropdown = document.getElementById('savedPlaylists');
  const categoryDropdown = document.getElementById('categoryDropdown');
  const fileInput = document.getElementById('playlistFile');
  const categoryChannelsList = document.getElementById('categoryChannelsList');
  const countLabel = document.getElementById('countLabel');

  // ========= Reproducci√≥n (HLS.js) =========
  let hlsInstance = null;
  function playStream(url){
    if(!url) return;
    if(hlsInstance){ try{ hlsInstance.destroy(); }catch(e){} hlsInstance = null; }

    const isHLS = /\.m3u8(\?|$)/i.test(url) || url.includes('.m3u8');
    if(isHLS && Hls.isSupported()){
      hlsInstance = new Hls({ enableWorker:true, lowLatencyMode:true });
      hlsInstance.loadSource(url);
      hlsInstance.attachMedia(video);
      hlsInstance.on(Hls.Events.MANIFEST_PARSED,()=>{ video.play().catch(()=>{}); });
      hlsInstance.on(Hls.Events.ERROR,(evt,data)=>{
        if(data && data.fatal){
          switch(data.type){
            case Hls.ErrorTypes.NETWORK_ERROR: hlsInstance.startLoad(); break;
            case Hls.ErrorTypes.MEDIA_ERROR: hlsInstance.recoverMediaError(); break;
            default: try{ hlsInstance.destroy(); }catch(e){}
          }
        }
      });
    } else {
      video.src = url;
      video.play().catch(()=>{});
    }
    currentStream = url;
  }

  // ========= Render de canales (bot√≥n rojo) =========
  function populateDropdown(opts = {}) {
    const { preserveScroll=false, autoplayIfEmpty=true } = opts;
    const st = preserveScroll ? channelList.scrollTop : 0;

    channelList.innerHTML = '';
    playlist.forEach((ch, idx) => {
      const row = document.createElement('div');
      row.className = 'channel-item';
      row.dataset.url = ch.url;
      row.dataset.index = String(idx);
      if (selectedSet.has(ch.url)) row.classList.add('selected');

      const name = document.createElement('div');
      name.className = 'channel-name';
      name.textContent = ch.name + (ch.group ? ` ‚Äî ${ch.group}` : '');

      const btn = document.createElement('button');
      btn.className = 'play-btn';
      btn.title = 'Reproducir';
      btn.textContent = '‚û§';
      btn.dataset.url = ch.url;

      row.appendChild(name);
      row.appendChild(btn);
      channelList.appendChild(row);
    });

    countLabel.textContent = String(playlist.length);
    if (autoplayIfEmpty && playlist.length && !currentStream) {
      playStream(playlist[0].url);
    }
    if (preserveScroll) channelList.scrollTop = st;
  }

  // Toggle selecci√≥n al hacer click en la fila. Si clic en bot√≥n rojo, reproduce.
  const clickPlayChk = document.getElementById('chkClickPlay');
  clickPlayChk.checked = localStorage.getItem('clickPlay') === 'true';
  clickPlayChk.addEventListener('change', ()=> localStorage.setItem('clickPlay', String(clickPlayChk.checked)));

  channelList.addEventListener('click', (e)=>{
    const btn = e.target.closest('.play-btn');
    if(btn){
      playStream(btn.dataset.url);
      return;
    }
    const item = e.target.closest('.channel-item');
    if(!item) return;
    const url = item.dataset.url;
    if(selectedSet.has(url)){ selectedSet.delete(url); item.classList.remove('selected'); }
    else { selectedSet.add(url); item.classList.add('selected'); }

    // clic reproduce (opcional)
    if(clickPlayChk.checked) playStream(url);

    // si est√° corriendo el auto-aleatorio, reinicia contador
    if(autoRandom.running){ autoRandom.remaining = autoRandom.seconds; updateCountdownDisplay(`${autoRandom.remaining}s`); }
  });

  // Filtro con preservaci√≥n de scroll
  document.getElementById('searchBox').addEventListener('input', (e)=>{
    const term = e.target.value.toLowerCase();
    const st = channelList.scrollTop;
    for(const row of channelList.children){
      const txt = row.querySelector('.channel-name')?.textContent.toLowerCase() || '';
      row.style.display = txt.includes(term) ? '' : 'none';
    }
    channelList.scrollTop = st;
    requestAnimationFrame(()=>{ channelList.scrollTop = st; });
  });

  // Helpers selecci√≥n
  function getSelectedItems(){
    if(!selectedSet.size) return [];
    const map = new Map(playlist.map(ch => [ch.url, ch]));
    return Array.from(selectedSet).map(u => map.get(u)).filter(Boolean);
  }
  function pickRandomFromSelection(){
    const sel = getSelectedItems();
    if(!sel.length){ alert('Selecciona uno o m√°s canales en la lista.'); return null; }
    return sel[Math.floor(Math.random()*sel.length)].url;
  }

  // ========= Temporizador Auto-Aleatorio =========
  const autoRandom = { running:false, tick:null, seconds:60, remaining:0 };
  const randSecondsInput = document.getElementById('randSeconds');
  const randRangeInput = document.getElementById('randRange');
  const countdownLabel = document.getElementById('countdownLabel');

  function syncSeconds(val){
    const n = Math.max(5, Math.min(3600, parseInt(val||60,10)));
    if(randSecondsInput) randSecondsInput.value = n;
    if(randRangeInput) randRangeInput.value = Math.min(n, parseInt(randRangeInput.max||1800,10));
    autoRandom.seconds = n;
    if(!autoRandom.running) updateCountdownDisplay('‚Äî');
  }
  if(randSecondsInput) randSecondsInput.addEventListener('input', e => syncSeconds(e.target.value));
  if(randRangeInput) randRangeInput.addEventListener('input', e => syncSeconds(e.target.value));

  function updateCountdownDisplay(v){ if(countdownLabel) countdownLabel.textContent = `Pr√≥ximo cambio en ${v}`; }

  function startAutoRandom(){
    if(autoRandom.tick) clearInterval(autoRandom.tick);
    const sel = getSelectedItems();
    if(!sel.length) { alert('Selecciona uno o m√°s canales para el modo Auto.'); return; }
    autoRandom.running = true;
    autoRandom.remaining = autoRandom.seconds;
    const first = pickRandomFromSelection();
    if(first) playStream(first);
    autoRandom.tick = setInterval(()=>{
      autoRandom.remaining -= 1;
      if(autoRandom.remaining <= 0){
        const next = pickRandomFromSelection();
        if(next) playStream(next);
        autoRandom.remaining = autoRandom.seconds;
      }
      updateCountdownDisplay(`${autoRandom.remaining}s`);
    }, 1000);
  }
  function pauseAutoRandom(){
    if(!autoRandom.running) return;
    autoRandom.running = false;
    if(autoRandom.tick) { clearInterval(autoRandom.tick); autoRandom.tick = null; }
    updateCountdownDisplay('pausado');
  }
  function resumeAutoRandom(){
    if(autoRandom.running) return;
    if(autoRandom.remaining<=0) autoRandom.remaining = autoRandom.seconds;
    autoRandom.running = true;
    if(autoRandom.tick) clearInterval(autoRandom.tick);
    autoRandom.tick = setInterval(()=>{
      autoRandom.remaining -= 1;
      if(autoRandom.remaining <= 0){
        const next = pickRandomFromSelection();
        if(next) playStream(next);
        autoRandom.remaining = autoRandom.seconds;
      }
      updateCountdownDisplay(`${autoRandom.remaining}s`);
    },1000);
  }
  function stopAutoRandom(){
    autoRandom.running = false;
    if(autoRandom.tick) { clearInterval(autoRandom.tick); autoRandom.tick = null; }
    autoRandom.remaining = 0;
    updateCountdownDisplay('‚Äî');
  }

  // ========= Botones y handlers =========
  document.getElementById('btnStartAuto').addEventListener('click', ()=>{ syncSeconds(randSecondsInput.value); startAutoRandom(); });
  document.getElementById('btnPauseAuto').addEventListener('click', ()=>{ if(autoRandom.running) pauseAutoRandom(); else resumeAutoRandom(); });
  document.getElementById('btnStopAuto').addEventListener('click', stopAutoRandom);

  const fileInputHandler = (evt)=>{
    const file = evt.target.files && evt.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      try{
        const text = e.target.result;
        const items = M3U.parse(text);
        if(!items.length) throw new Error('Lista vac√≠a o formato no reconocido');
        playlist = dedupeByUrl(items);
        populateDropdown({preserveScroll:true, autoplayIfEmpty:false});
      }catch(err){ console.error(err); alert('Error al cargar el playlist. Verifica el formato .m3u/.m3u8'); }
    };
    reader.readAsText(file);
  };
  fileInput.addEventListener('change', fileInputHandler);

  document.getElementById('btnPlay').addEventListener('click', ()=>{
    const sel = getSelectedItems();
    if(!sel.length) return alert('Selecciona uno o m√°s canales.');
    playStream(sel[0].url);
  });
  document.getElementById('btnPlayTop').addEventListener('click', ()=>{
    const sel = getSelectedItems();
    if(!sel.length) return alert('Selecciona uno o m√°s canales.');
    playStream(sel[0].url);
  });
  document.getElementById('btnRandomTop').addEventListener('click', ()=>{ const pick = pickRandomFromSelection(); if(pick) playStream(pick); });
  document.getElementById('btnAleatorio').addEventListener('click', ()=>{ const pick = pickRandomFromSelection(); if(pick) playStream(pick); });
  document.getElementById('btnStop').addEventListener('click', ()=>{ video.pause(); });
  document.getElementById('btnFav').addEventListener('click', agregarAFavoritos);

  // Atajos de teclado sobre lista
  channelList.addEventListener('keydown', (e)=>{
    const k = e.key.toLowerCase();
    if(k === 'enter' || k === 'p'){ const sel = getSelectedItems(); if(sel.length){ e.preventDefault(); playStream(sel[0].url);} }
    else if(k === 'r'){ e.preventDefault(); const pick = pickRandomFromSelection(); if(pick) playStream(pick); }
    else if(k === 'f'){ e.preventDefault(); agregarAFavoritos(); }
  });

  function dedupeByUrl(arr){ const seen=new Set(); const out=[]; for(const x of arr){ if(x && x.url && !seen.has(x.url)){ seen.add(x.url); out.push(x); } } return out; }

  // ========= Playlists localStorage =========
  function savePlaylist(){
    const name = (document.getElementById('playlistName').value||'').trim();
    if(!name) return alert('Escribe un nombre para la playlist');
    const selected = getSelectedItems().map(ch => ({ name: ch.name, url: ch.url }));
    if(!selected.length) return alert('Selecciona al menos un canal');
    localStorage.setItem(`playlist_${name}`, JSON.stringify(selected));
    loadAllPlaylists();
    alert('Playlist guardada.');
  }
  function loadSavedPlaylist(name){
    if(!name) return;
    const saved = localStorage.getItem(`playlist_${name}`);
    if(saved){
      try{
        const arr = JSON.parse(saved);
        if(Array.isArray(arr)){ playlist = dedupeByUrl(arr); }
        else { playlist = []; }
      }catch{ playlist = []; }
      selectedSet.clear();
      populateDropdown({preserveScroll:true, autoplayIfEmpty:false});
    }
  }
  function deleteSelectedPlaylist(){
    const name = savedPlaylistsDropdown.value;
    if(!name) return alert('Selecciona una playlist guardada');
    localStorage.removeItem(`playlist_${name}`);
    loadAllPlaylists();
  }
  function loadAllPlaylists(){
    savedPlaylistsDropdown.innerHTML = '<option value="">Selecciona una lista...</option>';
    for(const key of Object.keys(localStorage)){
      if(key.startsWith('playlist_')){
        const name = key.replace('playlist_','');
        const opt = document.createElement('option');
        opt.value = name; opt.text = name; savedPlaylistsDropdown.appendChild(opt);
      }
    }
    loadFavoritos();
    loadAllCategories();
  }
  document.getElementById('btnGuardarPL').addEventListener('click', savePlaylist);
  document.getElementById('btnLoadPL').addEventListener('click', ()=> loadSavedPlaylist(savedPlaylistsDropdown.value));
  document.getElementById('btnDeletePL').addEventListener('click', deleteSelectedPlaylist);
  document.getElementById('btnExportPL').addEventListener('click', ()=>{
    const name = savedPlaylistsDropdown.value || 'playlist';
    downloadText(M3U.toM3U(playlist), `${name}.m3u`);
  });

  // ========= Favoritos =========
  function agregarAFavoritos(){
    if(!currentStream) return alert('No hay canal reproduci√©ndose.');
    const canal = (playlist||[]).find(c => c.url===currentStream);
    const name = canal ? canal.name : (prompt('Nombre para el favorito:')||'Canal');
    let favs = [];
    try{ favs = JSON.parse(localStorage.getItem('favoritos')||'[]'); }catch{}
    if(!favs.find(f => f.url===currentStream)) favs.push({ name, url: currentStream });
    localStorage.setItem('favoritos', JSON.stringify(favs));
    loadFavoritos();
  }
  function loadFavoritos(){
    favoritosDropdown.innerHTML='';
    let favs=[]; try{ favs = JSON.parse(localStorage.getItem('favoritos')||'[]'); }catch{}
    for(const f of favs){ const o=document.createElement('option'); o.value=f.url; o.text=f.name; favoritosDropdown.appendChild(o); }
  }
  function reproducirFavorito(){ const url = favoritosDropdown.value; if(!url) return alert('Selecciona un canal favorito'); playStream(url); }
  function eliminarFavorito(){
    const url = favoritosDropdown.value; if(!url) return;
    let favs=[]; try{ favs = JSON.parse(localStorage.getItem('favoritos')||'[]'); }catch{}
    favs = favs.filter(f=>f.url!==url);
    localStorage.setItem('favoritos', JSON.stringify(favs));
    loadFavoritos();
  }
  document.getElementById('btnPlayFav').addEventListener('click', reproducirFavorito);
  document.getElementById('btnDelFav').addEventListener('click', eliminarFavorito);
  document.getElementById('btnExportFav').addEventListener('click', ()=>{
    let favs=[]; try{ favs = JSON.parse(localStorage.getItem('favoritos')||'[]'); }catch{}
    if(!favs.length) return alert('No hay favoritos.');
    downloadText(M3U.toM3U(favs), 'favoritos.m3u');
  });

  // ========= Categor√≠as (arreglado) =========
  function createCategory(){
    let name = (prompt('Nombre de la nueva categor√≠a:')||'').trim();
    if(!name) return;
    // nombre seguro para key
    name = name.replace(/\s+/g,' ').trim();
    const key = `cat_${name}`;
    if(!localStorage.getItem(key)){
      localStorage.setItem(key, JSON.stringify([]));
      loadAllCategories();
      alert('Categor√≠a creada.');
    } else {
      alert('Ya existe una categor√≠a con ese nombre.');
    }
  }
  function loadAllCategories(){
    categoryDropdown.innerHTML = '<option value="">Selecciona una categor√≠a...</option>';
    for(const key of Object.keys(localStorage)){
      if(key.startsWith('cat_')){
        const name = key.slice(4);
        const opt = document.createElement('option'); opt.value=name; opt.text=name; categoryDropdown.appendChild(opt);
      }
    }
  }
  function addToCategory(){
    const cat = categoryDropdown.value; if(!cat) return alert('Selecciona una categor√≠a primero');
    const selected = getSelectedItems().map(ch => ({ name: ch.name, url: ch.url }));
    if(!selected.length) return alert('Selecciona al menos un canal');
    const key = `cat_${cat}`;
    let data=[]; try{ data = JSON.parse(localStorage.getItem(key)||'[]'); }catch{}
    for(const c of selected){ if(!data.find(d=>d.url===c.url)) data.push(c); }
    localStorage.setItem(key, JSON.stringify(data));
    alert('Canales a√±adidos a la categor√≠a');
    if(categoryDropdown.value===cat) loadCategoryChannels();
  }
  function loadCategoryChannels(){
    const cat = categoryDropdown.value; categoryChannelsList.innerHTML='';
    if(!cat) return;
    let channels=[]; try{ channels = JSON.parse(localStorage.getItem(`cat_${cat}`)||'[]'); }catch{}
    for(const ch of channels){
      const li=document.createElement('li'); li.textContent=ch.name; li.style.cursor='pointer';
      li.onclick=()=> playStream(ch.url);
      categoryChannelsList.appendChild(li);
    }
  }
  document.getElementById('btnNewCat').addEventListener('click', createCategory);
  document.getElementById('btnAddToCat').addEventListener('click', addToCategory);
  categoryDropdown.addEventListener('change', loadCategoryChannels);

  // ========= Exportaciones =========
  function exportSelectionM3U(){
    const selected = getSelectedItems().map(ch => ({ name: ch.name, url: ch.url }));
    if(!selected.length) return alert('Selecciona uno o m√°s canales.');
    const text = M3U.toM3U(selected);
    downloadText(text, 'seleccion.m3u');
  }
  function downloadText(text, filename){
    const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 5000);
  }
  document.getElementById('btnExportSel').addEventListener('click', exportSelectionM3U);

  // ========= Auto-carga de listas internas =========
  const INTERNAL_FILES = ['update2.m3u','xumo.m3u','xiaomi.m3u'];
  function setInternalStatus(msg){ const el = document.getElementById('internalStatus'); if(el) el.textContent = msg; }
  function getSelectedInternal(){
    const items = Array.from(document.querySelectorAll('.internal-item'));
    const sel = items.filter(i => i.checked).map(i => i.value);
    return sel.length ? sel : INTERNAL_FILES.slice();
  }
  async function fetchTextNoStore(urlString, bust){
    const u = new URL(urlString, location.href);
    if(bust) u.searchParams.set('_ts', Date.now().toString());
    const res = await fetch(u.toString(), { cache: 'no-store' });
    if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
    const txt = await res.text();
    return { url: u.toString(), text: txt };
  }
  async function loadInternalLists({force=false} = {}){
    const merge = !!document.getElementById('chkMergeInternal')?.checked;
    const targets = getSelectedInternal();
    setInternalStatus('Cargando listas internas‚Ä¶');

    const results = await Promise.allSettled(targets.map(p => fetchTextNoStore(p, force)));

    let all = [], ok = 0, notes = [];
    for(let i=0;i<results.length;i++){
      const name = targets[i];
      const r = results[i];
      if(r.status === 'fulfilled'){
        const arr = M3U.parse(r.value.text) || [];
        ok++; notes.push(`${name}: ${arr.length}`);
        all.push(...arr);
      } else {
        notes.push(`${name}: ERROR`);
      }
    }

    const finalList = dedupeByUrl(all);
    playlist = merge ? dedupeByUrl([...(playlist||[]), ...finalList]) : finalList;

    populateDropdown({ preserveScroll: true, autoplayIfEmpty: false });
    setInternalStatus(ok ? `‚úÖ ${finalList.length} canales (${ok}/${targets.length}) ‚Äî ${notes.join(' ¬∑ ')}` : '‚ö†Ô∏è No se pudo cargar (revisa nombres/rutas o abre por http://)');
  }

  // ========= Inicio =========
  window.addEventListener('load', ()=>{
    playlist = [];
    populateDropdown();
    loadAllPlaylists();
    syncSeconds(60);

    // Botones internas
    const btnLoad = document.getElementById('btnLoadInternal');
    const btnForce = document.getElementById('btnForceInternal');
    const autoChk = document.getElementById('chkAutoInternal');

    const savedAuto = localStorage.getItem('autoInternal') === 'true';
    if(autoChk) autoChk.checked = savedAuto;
    autoChk?.addEventListener('change', ()=> {
      localStorage.setItem('autoInternal', String(autoChk.checked));
    });

    btnLoad?.addEventListener('click', ()=> loadInternalLists({force:false}));
    btnForce?.addEventListener('click', ()=> loadInternalLists({force:true}));

    if(savedAuto){ loadInternalLists({force:true}); }

    if(location.protocol === 'file:'){
      setInternalStatus('‚ö†Ô∏è Abierto como file:// ‚Äî usa un servidor local (Live Server) o GitHub Pages para cargar listas.');
    }
  });
  </script>
</body>
</html>
