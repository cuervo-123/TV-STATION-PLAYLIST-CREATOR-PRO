<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mi TV Station</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    :root{--bg:#0f1115;--fg:#e6e8eb;--accent:#00ffd5;--muted:#9aa4af}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    header,main{padding:16px;max-width:1100px;margin:0 auto}
    h1{margin:0 0 12px;font-weight:800;letter-spacing:.3px}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .col{flex:1 1 350px;min-width:300px}
    .panel{background:#131722;border:1px solid #222836;border-radius:14px;padding:14px;box-shadow:0 4px 24px rgba(0,0,0,.25)}
    .panel h3{margin:0 0 10px;color:var(--accent)}
    video{width:100%;height:360px;background:black;border-radius:12px}
    button,select,input{background:#1a2030;color:var(--fg);border:1px solid #2a3142;border-radius:10px;padding:10px 12px;font-size:14px}
    button{cursor:pointer}
    button:hover{border-color:#3b465c}
    select[multiple]{height:260px}
    ul{margin:8px 0 0;padding-left:20px}
    .muted{color:var(--muted)}
    .row.gap8{gap:8px}
    .tag{display:inline-block;background:#1e2536;border:1px solid #2b3448;border-radius:999px;padding:4px 10px;font-size:12px;color:#b7c1cc}
  </style>
</head>
<body>
  <header>
    <h1>üì∫ Mi TV Station</h1>
    <p class="muted">Carga listas <span class="tag">.m3u</span> / <span class="tag">.m3u8</span>, guarda favoritos, playlists y categor√≠as. Reproduce HLS con <strong>HLS.js</strong>.</p>
  </header>

  <main>
    <div class="row">
      <div class="col panel">
        <h3>Reproductor</h3>
        <video id="videoPlayer" controls autoplay playsinline></video>
        <div class="row gap8" style="margin-top:10px">
          <button id="btnFav">‚≠ê Agregar a Favoritos</button>
          <button id="btnAleatorio">‚ñ∂Ô∏è Aleatorio inmediato</button>
          <button id="btnStop">‚èπÔ∏è Stop</button>
        </div>
        <div style="margin-top:10px">
          <label>‚è±Ô∏è Tiempo entre aleatorios (segundos): </label>
          <input type="number" id="aleatorioTimerInput" value="60" min="5" style="width:80px" />
          <button id="btnStartAuto">‚ñ∂Ô∏è Iniciar Auto-Aleatorio</button>
          <button id="btnStopAuto">‚èπÔ∏è Detener Auto-Aleatorio</button>
        </div>
      </div>

      <div class="col panel">
        <h3>Canales</h3>
        <input id="searchBox" placeholder="Buscar por nombre o categor√≠a..." style="width:100%;margin-bottom:8px"/>
        <select id="channelDropdown" multiple size="12" style="width:100%"></select>
        <div class="row gap8" style="margin-top:8px">
          <button id="btnPlay">üì∫ Reproducir seleccionado</button>
          <button id="btnExportSel">‚¨áÔ∏è Exportar selecci√≥n (.m3u)</button>
        </div>
        <div class="muted" style="margin-top:6px"><span id="countLabel">0</span> canales cargados</div>
<!-- Auto-carga de listas internas -->
<div class="row gap8" style="margin-top:8px; align-items:center">
  <label class="muted" for="internalListSelect">Lista interna:</label>
  <select id="internalListSelect" style="flex:1; min-width:180px">
    <option value="all" selected>Todas (combinar)</option>
    <option value="update2.m3u">update2.m3u</option>
    <option value="xumo.m3u">xumo.m3u</option>
    <option value="xiaomi.m3u">xiaomi.m3u</option>
  </select>
  <label class="muted" style="display:flex; align-items:center; gap:6px;">
    <input type="checkbox" id="internalMerge" checked/> Fusionar con lista actual
  </label>
  <button id="btnLoadInternal">üì• Cargar</button>
  <span class="muted" id="internalStatus">‚Äî</span>
</div>

<!-- Panel avanzado (ocultable) para seleccionar m√∫ltiples listas internas -->
<div class="row" style="margin-top:8px; flex-direction:column; gap:8px;">
  <div class="row gap8" style="align-items:center;">
    <button id="toggleInternalBox">üß© Listas internas (mostrar/ocultar)</button>
    <span class="muted">Opcional: seleccionar varias listas espec√≠ficas</span>
  </div>
  <div id="internalBox" style="display:none; border:1px dashed #2a3142; border-radius:10px; padding:8px;">
    <div class="row gap8" style="align-items:center;">
      <select id="internalListMulti" multiple size="4" style="flex:1; min-width:240px">
        <option value="update2.m3u">update2.m3u</option>
        <option value="xumo.m3u">xumo.m3u</option>
        <option value="xiaomi.m3u">xiaomi.m3u</option>
      </select>
      <div class="row gap8" style="flex-wrap:wrap;">
        <button id="btnSelAllInternal">Seleccionar todo</button>
        <button id="btnClearInternal">Limpiar selecci√≥n</button>
        <button id="btnLoadInternalSel">üì• Cargar seleccionadas</button>
      </div>
    </div>
    <div class="muted" style="font-size:12px;">Usa el checkbox "Fusionar con lista actual" si no quieres reemplazar lo que ya est√° cargado.</div>
  </div>
</div>
      </div>
    </div>

    <!-- Resto igual que antes (playlists, favoritos, categor√≠as, editor) -->
    <!-- ... -->
  </main>

  <script>
  /* ================== Auto-carga de listas internas (3 samples) ==================
     Cambia estos nombres/rutas cuando subas tus archivos .m3u a GitHub. Puedes usar
     rutas relativas (por ejemplo dentro de una carpeta /lists del repo) o URLs absolutas. */
  const INTERNAL_PLAYLISTS = [
    'update2.m3u',
    'xumo.m3u',
    'xiaomi.m3u'
  ];

  // Elements helpers (evita conflictos si luego cambias IDs)
  function getDD(){ return document.getElementById('channelDropdown'); }
  function getVideo(){ return document.getElementById('videoPlayer'); }
  function getCount(){ return document.getElementById('countLabel'); }
  function setInternalStatus(msg){ const el = document.getElementById('internalStatus'); if(el) el.textContent = msg; }

  // Parser sencillo M3U (si no existe ya uno m√°s avanzado en tu app)
  if (typeof window.M3U === 'undefined') {
    window.M3U = {
      parse(text){
        const clean = (text||'').replace(/^Ôªø/, '').replace(/
?/g,'
');
        const lines = clean.split('
');
        const out = [];
        let nameTmp = null;
        for (let i=0;i<lines.length;i++){
          const line = lines[i].trim();
          if(!line || line.startsWith('#EXTM3U')) continue;
          if(line.startsWith('#EXTINF')){
            const comma = line.indexOf(',');
            nameTmp = (comma>-1 ? line.slice(comma+1).trim() : 'Canal');
            continue;
          }
          if(/^https?:\/\//i.test(line)){
            out.push({ name: nameTmp || 'Canal', url: line });
            nameTmp = null;
          }
        }
        return out;
      }
    };
  }

  // Estado m√≠nimo global compatible
  if (typeof window.playlist === 'undefined') window.playlist = [];
  if (typeof window.hlsInstance === 'undefined') window.hlsInstance = null;

  // Dedupe por URL
  function dedupeByUrl(arr){ const seen=new Set(); const out=[]; for(const x of (arr||[])){ if(x && x.url && !seen.has(x.url)){ seen.add(x.url); out.push(x);} } return out; }

  // Render de la lista (si no existe uno propio llamado populateDropdown)
  function renderDropdownFrom(list){
    const dd = getDD(); if(!dd) return;
    dd.innerHTML = '';
    (list||[]).forEach(ch => { const o=document.createElement('option'); o.value=ch.url; o.text=ch.name||'Canal'; dd.appendChild(o); });
    const c = getCount(); if(c) c.textContent = String(list?.length||0);
    if(list && list.length){ playStream(list[0].url); dd.selectedIndex = 0; }
  }

  // Reproducci√≥n b√°sica con HLS.js (solo si no existe ya playStream)
  if (typeof window.playStream !== 'function') {
    window.playStream = function(url){
      if(!url) return;
      const video = getVideo(); if(!video) return;
      if(window.hlsInstance){ try{ window.hlsInstance.destroy(); }catch(e){} window.hlsInstance = null; }
      const isHLS = /\.m3u8(\?|$)/i.test(url) || url.includes('.m3u8');
      if(isHLS && window.Hls && Hls.isSupported()){
        window.hlsInstance = new Hls({ enableWorker:true, lowLatencyMode:true });
        window.hlsInstance.loadSource(url);
        window.hlsInstance.attachMedia(video);
        window.hlsInstance.on(Hls.Events.MANIFEST_PARSED,()=>{ video.play().catch(()=>{}); });
        window.hlsInstance.on(Hls.Events.ERROR,(evt,data)=>{ if(data && data.fatal){ try{ window.hlsInstance.destroy(); }catch(e){} } });
      } else {
        video.src = url; video.play().catch(()=>{});
      }
    }
  }

  // Fetch seguro de texto
  async function fetchTextSafe(path){
    const url = encodeURI(String(path||'').trim());
    try{
      const res = await fetch(url, { cache: 'no-store' });
      if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      const txt = await res.text();
      return { ok:true, url, text:txt };
    }catch(err){ return { ok:false, url, error:String(err) }; }
  }

  // Cargar TODAS las listas internas y combinarlas
  async function loadInternalPlaylists(which='all', merge=false){
    setInternalStatus('Cargando listas internas‚Ä¶');
    const targets = Array.isArray(which)
      ? which
      : (which === 'all' ? INTERNAL_PLAYLISTS.slice() : [which]);

    const results = await Promise.all(targets.map(fetchTextSafe));

    const channels = [];
    let okCount = 0;
    for(const r of results){
      if(r.ok){ okCount++; try{ channels.push(...(M3U.parse(r.text)||[])); }catch(e){} }
    }
    const finalList = dedupeByUrl(channels);

    if(merge){ window.playlist = dedupeByUrl([...(window.playlist||[]), ...finalList]); }
    else { window.playlist = finalList; }

    if(typeof window.populateDropdown === 'function') window.populateDropdown(); else renderDropdownFrom(window.playlist);
    setInternalStatus(okCount ? `‚úÖ ${finalList.length} canales (${okCount}/${targets.length})` : '‚ö†Ô∏è No se pudo cargar (revisa rutas/CORS)');
  }catch(e){} }
    }
    const finalList = dedupeByUrl(channels);

    if(merge){ window.playlist = dedupeByUrl([...(window.playlist||[]), ...finalList]); }
    else { window.playlist = finalList; }

    if(typeof window.populateDropdown === 'function') window.populateDropdown(); else renderDropdownFrom(window.playlist);
    setInternalStatus(okCount ? `‚úÖ ${finalList.length} canales (${okCount}/${targets.length})` : '‚ö†Ô∏è No se pudo cargar (revisa rutas/CORS)');
  }
    }
    const finalList = dedupeByUrl(channels);
    if(merge){ window.playlist = dedupeByUrl([...(window.playlist||[]), ...finalList]); }
    else { window.playlist = finalList; }

    if(typeof window.populateDropdown === 'function') window.populateDropdown(); else renderDropdownFrom(window.playlist);
    setInternalStatus(okCount ? `‚úÖ ${finalList.length} canales` : '‚ö†Ô∏è No se pudo cargar (revisa rutas/CORS)');
  }

  // Bot√≥n y auto-carga al iniciar
  document.addEventListener('DOMContentLoaded', ()=>{
    const btn = document.getElementById('btnLoadInternal');
    const sel = document.getElementById('internalListSelect');
    const mergeCb = document.getElementById('internalMerge');

    // Nuevo: controles avanzados (panel ocultable + multi-select)
    const toggleBtn = document.getElementById('toggleInternalBox');
    const advBox   = document.getElementById('internalBox');
    const multiSel = document.getElementById('internalListMulti');
    const btnAll   = document.getElementById('btnSelAllInternal');
    const btnClr   = document.getElementById('btnClearInternal');
    const btnLoadS = document.getElementById('btnLoadInternalSel');

    const lastWhich = localStorage.getItem('lastInternalList') || 'all';
    const lastMerge = localStorage.getItem('lastInternalMerge') === 'true';
    if(sel) sel.value = lastWhich;
    if(mergeCb) mergeCb.checked = lastMerge;

    // Restaurar estado de visibilidad del panel
    const boxOpen = localStorage.getItem('internalBoxOpen') === 'true';
    if(advBox) advBox.style.display = boxOpen ? 'block' : 'none';

    // Bot√≥n carga de selecci√≥n simple
    if(btn) btn.addEventListener('click', ()=>{
      const which = sel ? sel.value : 'all';
      const merge = !!(mergeCb && mergeCb.checked);
      localStorage.setItem('lastInternalList', which);
      localStorage.setItem('lastInternalMerge', String(merge));
      loadInternalPlaylists(which, merge);
    });

    // Toggle del panel avanzado
    if(toggleBtn) toggleBtn.addEventListener('click', ()=>{
      if(!advBox) return;
      const willShow = advBox.style.display !== 'block';
      advBox.style.display = willShow ? 'block' : 'none';
      localStorage.setItem('internalBoxOpen', String(willShow));
    });

    // Seleccionar todo / limpiar multi-select
    function selectAll(el){ if(!el) return; Array.from(el.options).forEach(o => o.selected = true); }
    function clearAll(el){ if(!el) return; Array.from(el.options).forEach(o => o.selected = false); }

    if(btnAll) btnAll.addEventListener('click', ()=> selectAll(multiSel));
    if(btnClr) btnClr.addEventListener('click', ()=> clearAll(multiSel));

    // Cargar seleccionadas del multi-select
    if(btnLoadS) btnLoadS.addEventListener('click', ()=>{
      const merge = !!(mergeCb && mergeCb.checked);
      const choices = multiSel ? Array.from(multiSel.selectedOptions).map(o=>o.value) : [];
      if(!choices.length) return alert('Selecciona al menos una lista en el panel avanzado.');
      loadInternalPlaylists(choices, merge);
      // Guardar √∫ltima elecci√≥n como 'custom'
      localStorage.setItem('lastInternalList', 'all'); // mantenemos 'all' por compatibilidad del select simple
      localStorage.setItem('lastInternalMerge', String(merge));
    });

    // Auto-carga al abrir la app usando la √∫ltima elecci√≥n simple
    loadInternalPlaylists(lastWhich, lastMerge);
  });

    // Auto-carga al abrir la app usando la √∫ltima elecci√≥n
    loadInternalPlaylists(lastWhich, lastMerge);
  });

// ====== (todas las funciones previas M3U, reproducci√≥n, etc. se mantienen) ======

  let autoRandomInterval = null;

  document.getElementById('btnAleatorio').addEventListener('click', playRandomPreview);
  document.getElementById('btnStartAuto').addEventListener('click', ()=>{
    const seconds = parseInt(document.getElementById('aleatorioTimerInput').value,10);
    if(isNaN(seconds) || seconds<5){ return alert('Pon un valor v√°lido (>=5 segundos)'); }
    clearInterval(autoRandomInterval);
    autoRandomInterval = setInterval(playRandomPreview, seconds*1000);
    alert('Auto-Aleatorio iniciado cada '+seconds+' segundos');
  });
  document.getElementById('btnStopAuto').addEventListener('click', ()=>{
    clearInterval(autoRandomInterval);
    autoRandomInterval=null;
    alert('Auto-Aleatorio detenido');
  });

  function playRandomPreview(){
    const dd = getDD();
    if(!dd) return alert('No se encontr√≥ la lista de canales.');
    const selectedOptions = Array.from(dd.selectedOptions);
    if(selectedOptions.length===0) return alert('Selecciona uno o m√°s canales en la lista.');
    const pick = selectedOptions[Math.floor(Math.random()*selectedOptions.length)].value;
    playStream(pick);
  }
  </script>
</body>
</html>
